<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>YOLO - You Only Look Once | bruceyang</title>
    <meta name="generator" content="VuePress 1.7.1">
    <link rel="shortcut icon" href="https://avatars1.githubusercontent.com/u/33708068?s=400&amp;u=45d2437867b7706283aa9f1b7300b822e9c85f1b&amp;v=4">
    <link rel="apple-touch-icon" href="https://avatars1.githubusercontent.com/u/33708068?s=400&amp;u=45d2437867b7706283aa9f1b7300b822e9c85f1b&amp;v=4">
    <meta name="description" content="技术博客">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/assets/css/0.styles.e09f4a35.css" as="style"><link rel="preload" href="/assets/js/app.32056bf2.js" as="script"><link rel="preload" href="/assets/js/2.3d662a95.js" as="script"><link rel="preload" href="/assets/js/9.ba305593.js" as="script"><link rel="prefetch" href="/assets/js/10.f83da8c2.js"><link rel="prefetch" href="/assets/js/11.7a5d54ba.js"><link rel="prefetch" href="/assets/js/12.2880fe57.js"><link rel="prefetch" href="/assets/js/13.6a5f99b9.js"><link rel="prefetch" href="/assets/js/14.a80bca2f.js"><link rel="prefetch" href="/assets/js/3.1c9e49f8.js"><link rel="prefetch" href="/assets/js/4.25270e6b.js"><link rel="prefetch" href="/assets/js/5.0064911a.js"><link rel="prefetch" href="/assets/js/6.7d0ef18d.js"><link rel="prefetch" href="/assets/js/7.901f9289.js"><link rel="prefetch" href="/assets/js/8.54d04af0.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e09f4a35.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">bruceyang</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/Algorithm/" class="nav-link router-link-active">
  算法
</a></div><div class="nav-item"><a href="/Java/" class="nav-link">
  后端
</a></div><div class="nav-item"><a href="/Frontend/" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/Database/" class="nav-link">
  数据库
</a></div><div class="nav-item"><a href="/Tools/" class="nav-link">
  工具
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/Algorithm/" class="nav-link router-link-active">
  算法
</a></div><div class="nav-item"><a href="/Java/" class="nav-link">
  后端
</a></div><div class="nav-item"><a href="/Frontend/" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/Database/" class="nav-link">
  数据库
</a></div><div class="nav-item"><a href="/Tools/" class="nav-link">
  工具
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>算法</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Algorithm/" aria-current="page" class="sidebar-link">简介</a></li><li><a href="/Algorithm/chapter01-two-stage-detection.html" class="sidebar-link">目标检测 - RCNN 系列浅谈</a></li><li><a href="/Algorithm/chapter02-yolov1-v5.html" aria-current="page" class="active sidebar-link">YOLO - You Only Look Once</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Algorithm/chapter02-yolov1-v5.html#ren-wu-gai-shu" class="sidebar-link">任务概述</a></li><li class="sidebar-sub-header"><a href="/Algorithm/chapter02-yolov1-v5.html#yolo-she-ji-li-nian" class="sidebar-link">yolo 设计理念</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Algorithm/chapter02-yolov1-v5.html#wang-luo-jie-gou" class="sidebar-link">网络结构</a></li></ul></li><li class="sidebar-sub-header"><a href="/Algorithm/chapter02-yolov1-v5.html#wang-luo-shu-chu" class="sidebar-link">网络输出</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Algorithm/chapter02-yolov1-v5.html#sun-shi-han-shu" class="sidebar-link">损失函数</a></li><li class="sidebar-sub-header"><a href="/Algorithm/chapter02-yolov1-v5.html#gong-zuo-liu-cheng" class="sidebar-link">工作流程</a></li></ul></li><li class="sidebar-sub-header"><a href="/Algorithm/chapter02-yolov1-v5.html#yolo-fa-zhan" class="sidebar-link">yolo 发展</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Algorithm/chapter02-yolov1-v5.html#xian-yan-kuang" class="sidebar-link">先验框</a></li><li class="sidebar-sub-header"><a href="/Algorithm/chapter02-yolov1-v5.html#bian-kuang-yue-shu" class="sidebar-link">边框约束</a></li><li class="sidebar-sub-header"><a href="/Algorithm/chapter02-yolov1-v5.html#duo-chi-du-yu-ce" class="sidebar-link">多尺度预测</a></li></ul></li><li class="sidebar-sub-header"><a href="/Algorithm/chapter02-yolov1-v5.html#xing-neng-yi-lan" class="sidebar-link">性能一览</a></li><li class="sidebar-sub-header"><a href="/Algorithm/chapter02-yolov1-v5.html#reference" class="sidebar-link">Reference</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="yolo---you-only-look-once"><a href="#yolo---you-only-look-once" class="header-anchor">#</a> YOLO - You Only Look Once</h1> <h2 id="ren-wu-gai-shu"><a href="#ren-wu-gai-shu" class="header-anchor">#</a> 任务概述</h2> <p><img src="https://pic2.zhimg.com/80/v2-68048e7c5272aba98d7fbc96758ad38d_1440w.jpg" alt="">
图像理解的三个任务：分类、检测、分割。</p> <p>从理解的层次上说：分类 -&gt; image-level、检测 -&gt; region-level、分割 -&gt; pixel-level。</p> <p>作为图像理解的中层次，目标检测解决的问题是图片中【有什么】、【在哪里】。【有什么】对应着分类，【在哪里】对应着定位。</p> <ul><li><p>传统目标检测</p> <p>将检测问题简化成图像分类问题，原理是通过滑动窗口或者选择性搜索，将输入图像切成不同位置不同大小的区域，再对这些区域做分类，从而实现目标检测。
痛点：慢！且检测不同物体时，需要的检测框的大小和比例都不同。
<img src="https://img2018.cnblogs.com/blog/1423648/201903/1423648-20190317100459585-1587811888.png" alt=""></p></li> <li><p>双阶段检测</p> <p>RCNN 系列的提出，提高了目标检测的精度和速度。但还是需要中间区域 （Region Proposal）来判断候选框里有没有物体，然后再做目标的分类和边框回归。
<img src="https://pic4.zhimg.com/80/v2-597bf75a922c054ca038fe4c2fc9655f_1440w.jpg" alt=""></p></li></ul> <p>这个时候！YOLO 横空出世！提出了目标检测的另一种思路，将目标检测转换成一个回归问题，在一次前馈中同时推理出有没有物体、有什么物体、以及检测框的位置。2016 年，yolo1 就取得了 45 fps 的推理速度，且在当时其他实时的目标检测算法中是精度最高的。发展至今 yolo5 已经成为实时目标检测的首选框架。</p> <h2 id="yolo-she-ji-li-nian"><a href="#yolo-she-ji-li-nian" class="header-anchor">#</a> yolo 设计理念</h2> <h3 id="wang-luo-jie-gou"><a href="#wang-luo-jie-gou" class="header-anchor">#</a> 网络结构</h3> <p><img src="https://pic4.zhimg.com/80/v2-5d099287b1237fa975b1c19bacdfc07f_1440w.jpg" alt="">
yolo 的网络结构非常简单，就是单纯的卷积 + 池化 + 全链接，和分类网络几乎无差异。网络的输出为 7x7x30 的张量，包含目标检测中分类和定位的所有信息。一次前馈可以得到所有信息，所以取名 you only look once.</p> <p>理解 yolo，核心就是理解网络的<strong>输出构成</strong>和<strong>损失函数</strong>。</p> <h2 id="wang-luo-shu-chu"><a href="#wang-luo-shu-chu" class="header-anchor">#</a> 网络输出</h2> <p><img src="https://pic2.zhimg.com/v2-850969b88edb6f9ce6506ab241333aae_1440w.jpg?source=172ae18b" alt=""></p> <ul><li><p>7x7 网格</p> <p>输入大小为 448x448 的图像，通过卷积网络降采样 64 倍，得到 7x7 的特征图。</p></li> <li><p>30 维向量</p> <p>每个网格对应一个 30 维向量，其中包含了 20 个检测对象的分类概率、每个网格为中心负责预测的 2 个 bbox 的置信度、以及这两个 bbox 的位置表示。</p> <ul><li><p>分类概率： YOLO 支持识别 20 种不同的对象（人、鸟、猫、汽车、椅子等），所以这里有 20 个值表示该网格位置存在任一种对象的概率。</p></li> <li><p>bbox 位置： 4 个数值的坐标表示 $(\text {center_x}, \text {center_y}, \text {width}, \text {height})$</p></li> <li><p>bbox 置信度： $\text { Confidence } = \text { Pr }(\text { Object }) * \text { IOU }_\text { pred }^\text { truth }$，然后看 2 个 bbox 的 IOU，哪个比较大（更接近 ground truth ），就由哪个 bbox 来负责预测该对象是否存在.</p></li></ul> <p>30 维向量 = 20 个对象的分类概率 + 2 个 bbox * 4 个坐标 + 2 个 bbox 的置信度</p></li></ul> <p>所以总体网络输出为 7x7x30 的张量</p> <h3 id="sun-shi-han-shu"><a href="#sun-shi-han-shu" class="header-anchor">#</a> 损失函数</h3> <p><img src="https://sns-img-qc.xhscdn.com/20210526135958222-v2-d3de934214afa4a5790463f7f23f2e38_1440w.jpeg" alt="">
损失函数中记录了三种误差信息：边框、置信度、分类，损失函数中各个损失项与输出的 30 维向量中的内容对应。细节见上图。</p> <p>对于损失函数中权重的设置，</p> <ul><li>更重视 8 维的坐标预测，给这些损失前面赋予更大的权重 5。</li> <li>对没有 object 的 box 的 confidence loss，赋予小的权重 0.5。</li> <li>有 object 的 box 的 confidence loss 和类别的 loss ，权重正常取 1。</li></ul> <p>总的来说，就是用网络输出与样本标签的各项内容的误差平方和作为一个样本的整体误差。 损失函数中的几个项是与输出的 30 维向量中的内容相对应的。</p> <h3 id="gong-zuo-liu-cheng"><a href="#gong-zuo-liu-cheng" class="header-anchor">#</a> 工作流程</h3> <p><img src="https://pic4.zhimg.com/80/v2-40c8cbed60aba0fe2faa38e240b8563b_1440w.jpg" alt=""></p> <p><img src="https://pic3.zhimg.com/80/v2-258df167ee37b5594c72562b4ae61d1a_1440w.jpg" alt=""></p> <p>训练好的 YOLO 网络，输入一张图片，将输出一个 7x7x30 的张量来表示图片中所有网格包含的对象（概率）、该对象可能的 2 个位置（ bbox ）和置信度。
采用 NMS（Non-maximal suppression，非极大值抑制）算法，选择得分最高的作为输出，去掉与该输出重叠度高的框。</p> <p>yolo1 使用 softmax 做类别分类，所以一张图片最多可以检测出 7 x 7 = 49 个对象。在检测密集物体、小物体时效果不理想。那这个问题怎么解决呢？请往下看。</p> <h2 id="yolo-fa-zhan"><a href="#yolo-fa-zhan" class="header-anchor">#</a> yolo 发展</h2> <p>从 yolo2 到 5，每一个版本改进都是在 yolo 的中心设计思想的基础上引入当时 cv 领域的优秀 trick 和网络结构的调整，每篇论文的可读性都非常高，这里只挑选介绍。</p> <h3 id="xian-yan-kuang"><a href="#xian-yan-kuang" class="header-anchor">#</a> 先验框</h3> <div class="custom-block tip"><p class="custom-block-title">改进前后对比</p> <p>改进前： 一个网格预测两个检测框，边框大小全靠网络学习</p> <p>改进后： 预设检测框更符合数据集分布</p></div> <p>yolo2 中，作者借鉴 Faster R-CNN 的 9 个预设矩形框，也引入 anchor box 的概念。不同的是，yolo2 中的 Anchor Box 的宽高不经过人为获得，而是将训练数据集中的 ground truth 矩形框全部拿出来，用 k-means 聚类得到先验框的宽和高。先验框只与检测框的 w、h 有关，与 x、y 无关。</p> <p><img src="https://sns-img-qc.xhscdn.com/20210525183459786-wecom20210525-1834172x.png" alt=""></p> <p>例如 yolo2 使用 5 个 Anchor Box，那么 k-means 聚类的类别中心个数设置为 5。加入了聚类操作之后，引入 Anchor Box 之后，mAP 上升。</p> <p>k-means 对训练集中的边界框做了聚类分析，定义聚类点之间的距离函数如下：</p> <p>$$
d(\text { box }, \text { centroid })=1-\text { IOU(box, centroid) }
$$</p> <h3 id="bian-kuang-yue-shu"><a href="#bian-kuang-yue-shu" class="header-anchor">#</a> 边框约束</h3> <div class="custom-block tip"><p class="custom-block-title">改进前后对比</p> <p>改进前： 预测边框坐标和大小的绝对值，可能造成差值过大模型难以收敛</p> <p>改进后： 边框约束，更稳定</p></div> <p>同样借鉴 RCNN 系列，网络输出的 bbox 的位置坐标，其实是偏移量 tx, ty 和尺度缩放 tw, th，想要得到检测框的真是坐标，需要通过图中公式解码。</p> <p><img src="https://sns-img-qc.xhscdn.com/20210526104503784-wecom20210525-2032422x.png" alt=""></p> <p>$\sigma\left(t_{x}\right)$，$\sigma\left(t_{y}\right)$ 是基于矩形框中心点左上角格点坐标的偏移量，$p_{w}$，$p_{h}$ 是聚类得到的先验框宽和高。</p> <p>使用 <strong>sigmoid</strong> 作为激活函数，约束偏移量在 0 到 1 之间，保证预测的中心坐标在该网格内。</p> <h3 id="duo-chi-du-yu-ce"><a href="#duo-chi-du-yu-ce" class="header-anchor">#</a> 多尺度预测</h3> <div class="custom-block tip"><p class="custom-block-title">改进前后对比</p> <p>改进前： 只在 7x7 的特征图上预测，容易缺失信息</p> <p>改进后： 三种不同大小的特征图，负责检测不同大小的物体</p></div> <p>yolo3 引入多尺度预测，为了更好的预测不同大小的目标物体。</p> <p><img src="https://sns-img-qc.xhscdn.com/20210525202108400-wecom20210525-2020252x.png" alt=""></p> <p>输入 416 x 416 尺寸的图片，通过卷积分别实现降采样 8、16、32 倍，得到三个尺寸的特征图。特征图上每个网格单元预测 3 个 box，每个 box 需要有 (x, y, w, h, confidence) 五个基本参数，然后还要有 80 个类别的概率。所以 255 由来就是 （5 + 80）* 3。</p> <p><img src="https://sns-img-qc.xhscdn.com/20210525202206478-wecom20210525-2021402x.png" alt=""></p> <p>对于不同尺寸的特征图，特征图越小，经过的卷积层数越多，在原图上的感受野就越大。所以特征图越小，越适合预测大尺寸的物体，使用的先验框就越大。</p> <p><img src="https://sns-img-qc.xhscdn.com/20210525165802733-wecom20210525-1657302x.png" alt=""></p> <p>模型上的改进也很大，模型 backbone 使用 darknet，同时借鉴了残差结构和特征金字塔的张量 concat 等，不多介绍。</p> <p>损失函数新定义</p> <p><img src="https://www.zhihu.com/equation?tex=loss_%7BN_1%7D+%3D+%5Clambda_%7Bbox%7D%5Csum_%7Bi%3D0%7D%5E%7BN_1%5Ctimes+N_1%7D%5Csum_%7Bj%3D0%7D%5E%7B3%7D%7B1_%7Bij%7D%5E%7Bobj%7D%5B%28t_x+-+t_x%27%29%5E2+%2B+%28t_y+-+t_y%27%29%5E2%5D%7D+%5C%5C+%2B%5Clambda_%7Bbox%7D%5Csum_%7Bi%3D0%7D%5E%7BN_1%5Ctimes+N_1%7D%5Csum_%7Bj%3D0%7D%5E%7B3%7D%7B1_%7Bij%7D%5E%7Bobj%7D%5B%28t_w+-+t_w%27%29%5E2+%2B+%28t_h+-+t_h%27%29%5E2%5D%7D++%5C%5C+-+%5Clambda_%7Bobj%7D%5Csum_%7Bi%3D0%7D%5E%7BN%5Ctimes+N%7D%5Csum_%7Bj%3D0%7D%5E%7B3%7D%7B1_%7Bij%7D%5E%7Bobj%7Dlog%28c_%7Bij%7D%29%7D+%5C%5C+-%5Clambda_%7Bnoobj%7D%5Csum_%7Bi%3D0%7D%5E%7BN_1%5Ctimes+N_1%7D%5Csum_%7Bj%3D0%7D%5E%7B3%7D%7B1_%7Bij%7D%5E%7Bnoobj%7Dlog%281-c_%7Bij%7D%29%7D+%5C%5C+-%7B%5Clambda%7D_%7Bclass%7D%5Csum_%7Bi%3D0%7D%5E%7BN_1%5Ctimes+N_1%7D%5C%5C%5Csum_%7Bj%3D0%7D%5E%7B3%7D%7B1_%7Bij%7D%5E%7Bobj%7D+%5Csum_%7Bc+%5Cin+classes+%7D%5Bp_%7Bij%7D%27%28c%29log%28p_%7Bij%7D%28c%29%29%2B%281-p_%7Bij%7D%27%28c%29%29log%281-p_%7Bij%7D%28c%29%29%5D+%7D+" alt=""></p> <p>softmax + mse 改为 sigmoid + bce，支持多标签分类，解决了同一网格中目标可能有重叠的类别标签。</p> <p>总 loss 为三个尺寸的特征图上 loss 之和</p> <p><img src="https://www.zhihu.com/equation?tex=Loss%3Dloss_%7BN_1%7D++%2Bloss_%7BN_2%7D+%2Bloss_%7BN_3%7D++%5C%5C" alt=""></p> <p>引入多尺度特征图后，输入为 416 x 416 的图片能生成的预测框总数量为 52 * 52 * 3 + 26 * 26 * 3 + 13 * 13 * 3 = 10647，相比 yolo1 中 7 * 7 * 2 个检测框新增很多，大大提升了检测密集物体的能力。</p> <h2 id="xing-neng-yi-lan"><a href="#xing-neng-yi-lan" class="header-anchor">#</a> 性能一览</h2> <p><img src="https://sns-img-qc.xhscdn.com/20210526102235038-wecom20210525-2031352x.png" alt="">
yolo4 的性能总结：快，也准！v5 虽然没有官方的性能评估，但根据 <a href="https://github.com/ultralytics/yolov5" target="_blank" rel="noopener noreferrer">GitHub<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> ，yolo5 在 tesla V100 上最高可达 250 FPS，且保持了较高的 mAP。而且 yolov5 训练所需时间相比 v4 更少。</p> <p>yolo4 和 5 都支持不同大小的 backbone 模型，可根据使用场景选择合适的模型部署。</p> <h2 id="reference"><a href="#reference" class="header-anchor">#</a> Reference</h2> <ol><li>You Only Look Once: Unified, Real-Time Object Detection https://arxiv.org/abs/1506.02640</li> <li>YOLO9000: Better, Faster, Stronger https://arxiv.org/abs/1612.08242</li> <li>YOLOv3: An Incremental Improvement https://arxiv.org/abs/1804.02767</li> <li>YOLOv4: Optimal Speed and Accuracy of Object Detection https://arxiv.org/abs/2004.10934</li> <li>YOLO v5 GitHub https://github.com/ultralytics/yolov5</li></ol> <p>一些彩蛋</p> <blockquote><p><em>I have a lot of hope that most of the people using computer vision are just doing happy, good stuff with it, like counting the number of zebras in a national park, or tracking their cat as it wanders around their house. But computer vision is already being put to questionable use and as researchers we have a responsibility to at least consider the harm our work might be doing and think of ways to mitigate it. We owe the world that much.</em></p></blockquote> <p>（论文尾部，作者对于行业的思考）</p> <blockquote><p>yolo3 论文短小的风格、诡异的文风、神奇的措辞，彻底放飞自我：我随便写的，你们也就随便看看吧，反正我的效果好你肯定要引用我，还顺带嘲讽了一波 retinanet。</p></blockquote> <p>（以上立场来自知乎某网友，本人概不负责）</p> <p>最后附上 yolo 一作的彩虹小白马简历
<img src="https://sns-img-qc.xhscdn.com/20210526115202887-wecom20210526-1151422x.png" alt=""></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/Algorithm/chapter01-two-stage-detection.html" class="prev">
        目标检测 - RCNN 系列浅谈
      </a></span> <!----></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.32056bf2.js" defer></script><script src="/assets/js/2.3d662a95.js" defer></script><script src="/assets/js/9.ba305593.js" defer></script>
  </body>
</html>
